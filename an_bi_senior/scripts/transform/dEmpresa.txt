let
    Fonte = Csv.Document(Web.Contents("https://raw.githubusercontent.com/TesteBINeoway/testeAnalistaBI/main/an_bi_senior/spreadsheets/empresas_bolsa.csv"),[Delimiter=";", Columns=13, Encoding=65001, QuoteStyle=QuoteStyle.None]),
    #"Cabeçalhos Promovidos" = Table.PromoteHeaders(Fonte, [PromoteAllScalars=true]),
    #"Colunas Removidas1" = Table.RemoveColumns(#"Cabeçalhos Promovidos",{"id", "cd_acao_rdz", "nm_segmento_b3", "tx_cnpj", "created_at", "updated_at"}),
    #"Texto Aparado" = Table.TransformColumns(#"Colunas Removidas1",{{"cd_acao", Text.Trim, type text}}),
    #"Texto Limpo" = Table.TransformColumns(#"Texto Aparado",{{"cd_acao", Text.Clean, type text}}),
    #"Dividir Coluna por Delimitador" = Table.SplitColumn(#"Texto Limpo", "cd_acao", Splitter.SplitTextByDelimiter(", ", QuoteStyle.Csv), {"cd_acao.1", "cd_acao.2", "cd_acao.3", "cd_acao.4", "cd_acao.5"}),
    #"Colunas Não Dinâmicas" = Table.UnpivotOtherColumns(#"Dividir Coluna por Delimitador", {"nm_empresa", "setor_economico", "subsetor", "segmento", "segmento_b3", "vl_cnpj"}, "Atributo", "cd_acao"),
    #"Linhas Filtradas" = Table.SelectRows(#"Colunas Não Dinâmicas", each ([Atributo] <> "nm_empresa")),
    #"Colunas Removidas" = Table.RemoveColumns(#"Linhas Filtradas",{"Atributo"}),
    #"Tipo Alterado" = Table.TransformColumnTypes(#"Colunas Removidas",{{"vl_cnpj", Int64.Type}}),
    #"Consultas Mescladas" = Table.NestedJoin(#"Tipo Alterado", {"vl_cnpj"}, df_empresas, {"cnpj"}, "df_empresas", JoinKind.LeftOuter),
    #"df_empresas Expandido" = Table.ExpandTableColumn(#"Consultas Mescladas", "df_empresas", {"dt_abertura", "de_ramo_atividade", "de_setor", "endereco_cep", "endereco_municipio", "endereco_uf", "endereco_regiao", "endereco_mesorregiao", "nivel_atividade", "empresa_porte", "saude_tributaria", "optante_simples", "optante_simei"}, {"dt_abertura", "de_ramo_atividade", "de_setor", "endereco_cep", "endereco_municipio", "endereco_uf", "endereco_regiao", "endereco_mesorregiao", "nivel_atividade", "empresa_porte", "saude_tributaria", "optante_simples", "optante_simei"}),
    #"Colunas Removidas2" = Table.RemoveColumns(#"df_empresas Expandido",{"vl_cnpj"}),
    #"Linhas Filtradas1" = Table.SelectRows(#"Colunas Removidas2", each ([cd_acao] <> "")),
    #"Texto em Minúscula Inserido" = Table.AddColumn(#"Linhas Filtradas1", "nome", each Text.Lower([nm_empresa]), type text),
    #"Valor Substituído" = Table.ReplaceValue(#"Texto em Minúscula Inserido"," ","-",Replacer.ReplaceText,{"nome"}),
    #"Personalização Adicionada" = Table.AddColumn(#"Valor Substituído", "Link_B3", each "https://s3-symbol-logo.tradingview.com/" & [nome] & "--big.svg"),
    #"Tipo Alterado1" = Table.TransformColumnTypes(#"Personalização Adicionada",{{"Link_B3", type text}}),
    #"Primeiros Caracteres Inseridos" = Table.AddColumn(#"Tipo Alterado1", "4", each Text.Start([cd_acao], 4), type text),
    #"Personalização Adicionada1" = Table.AddColumn(#"Primeiros Caracteres Inseridos", "Link_iValor", each "https://www.ivalor.com.br/media/emp/logos/" & [4] & ".png"),
    #"Tipo Alterado2" = Table.TransformColumnTypes(#"Personalização Adicionada1",{{"Link_iValor", type text}}),
    #"Valor Substituído1" = Table.ReplaceValue(#"Tipo Alterado2",".",",",Replacer.ReplaceText,{"setor_economico", "subsetor"}),
    #"Consultas Mescladas1" = Table.NestedJoin(#"Valor Substituído1", {"endereco_uf"}, Aux_Estados, {"Sigla"}, "Aux_Estados", JoinKind.LeftOuter),
    #"Aux_Estados Expandido" = Table.ExpandTableColumn(#"Consultas Mescladas1", "Aux_Estados", {"Estado"}, {"Estado"}),
    #"Colunas Renomeadas" = Table.RenameColumns(#"Aux_Estados Expandido",{{"setor_economico", "Setor Econômico"}, {"segmento_b3", "Segmento B3"}, {"cd_acao", "Ação"}, {"de_ramo_atividade", "Ramo de Atividade"}, {"de_setor", "Setor"}, {"nivel_atividade", "Nível de Atividade"}, {"empresa_porte", "Porte"}, {"saude_tributaria", "Saúde Tributária"}, {"segmento", "Segmento"}, {"subsetor", "Subsetor"}}),
    #"Personalização Adicionada2" = Table.AddColumn(#"Colunas Renomeadas", "Últ Cotação Fixa", each "21/10/2022"),
    #"Tipo Alterado3" = Table.TransformColumnTypes(#"Personalização Adicionada2",{{"Últ Cotação Fixa", type date}}),
    #"Personalização Adicionada3" = Table.AddColumn(#"Tipo Alterado3", "Idade Empresa", each [Últ Cotação Fixa] - [dt_abertura]),
    #"Total de Anos Inseridos" = Table.AddColumn(#"Personalização Adicionada3", "Total de Anos", each Duration.TotalDays([Idade Empresa]) / 365, type number),
    #"Tipo Alterado4" = Table.TransformColumnTypes(#"Total de Anos Inseridos",{{"Total de Anos", Int64.Type}}),
    #"Colunas Removidas3" = Table.RemoveColumns(#"Tipo Alterado4",{"Últ Cotação Fixa", "Idade Empresa"})
in
    #"Colunas Removidas3"